# セキュリティ実装ガイド

## 🔒 実装済みのセキュリティ対策

### 1. 入力検証とサニタイズ
- ✅ 入力長の制限（10,000文字）
- ✅ 危険な文字列の検出とブロック
- ✅ プロンプトインジェクション攻撃の防止
- ✅ 症例番号・分野番号の範囲チェック

### 2. レート制限
- ✅ クライアント側での簡易レート制限（10リクエスト/分）
- ⚠️ 本番環境ではサーバー側でのレート制限を推奨

### 3. エラーメッセージの改善
- ✅ 詳細なエラー情報の非表示
- ✅ 汎用的なエラーメッセージの表示

### 4. セキュリティヘッダー
- ✅ CSP（Content Security Policy）の設定
- ✅ XSS保護ヘッダー
- ✅ クリックジャッキング対策

---

## ⚠️ 残っている重大な問題

### 1. APIキーの保護（最重要）

**現状:**
- APIキーがクライアント側のJavaScriptに埋め込まれる
- 誰でもブラウザの開発者ツールで確認可能

**推奨される解決策:**

#### オプションA: バックエンドプロキシサーバー（推奨）

```
クライアント → バックエンドAPI → AI API
              (APIキーはサーバー側で管理)
```

**実装例（Node.js + Express）:**

```javascript
// server.js
const express = require('express');
const app = express();

app.post('/api/create-summary', async (req, res) => {
  const { caseNumber, fieldNumber, voiceInputText } = req.body;
  
  // 入力検証
  // サニタイズ
  
  // AI API呼び出し（APIキーは環境変数から）
  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'gpt-4',
      messages: [/* ... */],
    }),
  });
  
  const data = await response.json();
  res.json(data);
});
```

#### オプションB: Vercel/Netlify Functions

```typescript
// api/create-summary.ts
export default async function handler(req, res) {
  const apiKey = process.env.OPENAI_API_KEY;
  // API呼び出し
}
```

#### オプションC: GitHub Actions + サーバーレス関数

---

### 2. 医療情報の暗号化

**推奨事項:**
- データ転送時: HTTPS必須（GitHub Pagesは自動）
- データ保存時: 必要に応じて暗号化
- ブラウザメモリ: 使用後は即座にクリア

**実装例:**

```typescript
// データ使用後のクリア
function clearSensitiveData() {
  setResult(null);
  setVoiceInputText('');
  // ガベージコレクションを促す
  if (window.gc) {
    window.gc();
  }
}
```

---

### 3. ログ管理

**推奨事項:**
- 個人情報を含むログは記録しない
- ログは暗号化して保存
- ログの保持期間を設定（例: 30日）

---

## 📋 セキュリティチェックリスト

### 開発時
- [ ] 入力検証の実装
- [ ] サニタイズの実装
- [ ] エラーハンドリングの改善
- [ ] レート制限の実装

### デプロイ前
- [ ] APIキーの保護（バックエンドプロキシ）
- [ ] HTTPSの確認
- [ ] セキュリティヘッダーの設定
- [ ] 脆弱性スキャンの実施

### 本番環境
- [ ] 定期的なセキュリティ監査
- [ ] ログの監視
- [ ] インシデント対応計画の準備

---

## 🔐 コンプライアンス

### 個人情報保護法（日本）
- ✅ データの最小化
- ✅ 適切な管理
- ⚠️ 暗号化（要実装）
- ⚠️ アクセス制御（要実装）

### HIPAA（米国の場合）
- ✅ HTTPS（データ転送時の暗号化）
- ⚠️ データ保存時の暗号化（要実装）
- ⚠️ アクセス制御（要実装）
- ⚠️ 監査ログ（要実装）

---

## 🚨 緊急時の対応

### APIキーが漏洩した場合
1. 即座にAPIキーを無効化
2. 新しいAPIキーを発行
3. 使用状況を確認
4. 必要に応じて関係者に通知

### データ漏洩が発生した場合
1. 影響範囲の特定
2. 漏洩したデータの確認
3. 関係機関への報告（必要に応じて）
4. 再発防止策の実施

---

## 📚 参考資料

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [OWASP API Security Top 10](https://owasp.org/www-project-api-security/)
- [個人情報保護法](https://www.ppc.go.jp/)
- [HIPAA](https://www.hhs.gov/hipaa/index.html)
